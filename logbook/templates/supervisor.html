{% extends 'base.html' %}

{% load static %}
{% load filters %}

{% block titleblock %}Guild Volunteering System{% endblock %}

{% block sideblock %}
<div class="col-sm-2 col-md-2 sidebar">

    <h3>Overview</h3>
    <ul class="nav nav-sidebar">
        <li class="active"><a href=".">Approve Hours</a><span class="sr-only">(current)</span></li>
        <li><a href="{% url 'logbook:list' %}#statistics">Statistics</a></li>
    </ul>
</div>
{% endblock %}

{% block bodyblock %}
<div class="col-sm-10 col-sm-offset-2 col-md-10 col-md-offset-2 main">
    <div class="visible-xs">
        <a href="{% url 'logbook:index' %}" class="visible-xs" style="float:left"><span style="font-size: 40; position:relative;top:-10px;">&larr;</span></a> <h1 class="page-header">Approve Volunteer Hours</h1>
    </div>
    <h1 class="page-header hidden-xs">Approve Volunteer Hours</h1>
    {% if logbooks %}
    <form method="post" id="modelForm" onsubmit="return false">
            {% csrf_token %}
            <select name="selectedAction" hidden="true" id="actions">
                <option value="none"></option>
                <option value="approve"></option>
                <option value="decline"></option>
            </select>
            
        <div class="panel-group" id="accordion">
            {% for logbook in logbooks %}
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4>
                            <a data-toggle="collapse" data-parent="#accordion" href="#{{ logbook.book__id }}"><h4>{{ logbook.book__user__user__first_name }} {{ logbook.book__user__user__last_name }} - {{ logbook.book__user__user__username }} <span class = "badge">{{ logbook.entries_pending }}</span> </h4></a>
                    </div>

                    <div id="{{ logbook.book__id }}" class="panel-collapse collapse">
                        <div class="panel-body">
                            <table class="table table-responsive table-striped" id="table-{{logbook.book__id}}">
                                <thead>
                                    <tr>
                                        <th>Start Time</th>
                                        <th>End Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if entries %}
                                    {% for logentry in entries %}
                                        {% if logentry.book.id == logbook.book__id %}
                                        <tr class = "">
                                            <td class="hidden"><input type="checkbox" name="model_selected" value="{{ logentry.id }}" id="check-{{logentry.id}}"></td>
                                            <td>{{ logentry.start|date:"d/m/y P" }}</td>
                                            <td>{{ logentry.end|date:"d/m/y P" }}</td>
                                            <td>
                                                <div class='btn-toolbar'>
                                                    <button class="btn btn-success visible-xs" id="superActionButtn" onclick="doOne('check-{{logentry.id}}','approve')"><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></button>
                                                    <button class="btn btn-danger visible-xs" id="superActionButtn" onclick="doOne('check-{{logentry.id}}', 'decline')"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                                                    <button class="btn btn-success hidden-xs" id="superActionButtn1" onclick="doOne('check-{{logentry.id}}','approve')">Approve</button>
                                                    <button class="btn btn-danger hidden-xs" id="superActionButtn" onclick="doOne('check-{{logentry.id}}', 'decline')">Decline</button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <div class="panel-footer">
                            <h4>Total of {{ logbook.entries_pending_total_duration|timedelta }} to be approved</h4>
                            <button class="btn btn-success" onclick="submitAll('table-{{logbook.book__id}}')">Approve All</button>
                            <button class="btn btn-lg btn-inverse" onclick="location.href='mailto:{{logbook.book__user__user__username}}@student.uwa.edu.au'"><span class="glyphicon glyphicon-envelope"></span></button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </form>
    {% else %}
    <div style="padding-top: 10px;">
        <p><h4>You do not have any hours to approve, please come back later and check.</h4></p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block footerblock %}
<script src="{% static 'js/ajax.js' %}"></script>
<script type="text/javascript">
    
    function getCookie(name) {
        var cookieValue = null;
        var i = 0;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (i; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        crossDomain: false, // obviates need for sameOrigin test
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    }); 
    
    $('#superActionButtn1').click(function(){
        
        $.ajax({
            type: "post",
            url: "./updatehrs/",
            contentType: "application/json",
            async:true,
            data:{csrfmiddlewaretoken: '{{crsf_token}}',},
            success: function(data) {
                alert(data.result);
            }
        });
    });
    
    form = document.getElementById('modelForm');
    actions = document.getElementById('actions');
    function doOne(cehckboxid, action) {
        document.getElementById(cehckboxid).checked = true;
        actions.value = action;
    }
    function submitAll(tableid) {
        table = document.getElementById(tableid);
        checkboxes = table.querySelectorAll('[name=model_selected]');
        for (var i=0; i<checkboxes.length; i++) {
            checkboxes[i].checked = true;
        }
        actions.value = 'approve';
        
    }
</script>
{% endblock%}
